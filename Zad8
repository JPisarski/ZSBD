-- zadanie 1

CREATE TABLE archiwum_departamentow (
    id NUMBER PRIMARY KEY,
    nazwa VARCHAR2(100),
    data_zamkniecia DATE,
    ostatni_manager VARCHAR2(200)
);

CREATE OR REPLACE TRIGGER archive_department
AFTER DELETE ON departments
FOR EACH ROW
DECLARE
    v_manager VARCHAR2(200);
BEGIN
    
    SELECT first_name || ' ' || last_name
    INTO v_manager FROM employees
    WHERE employee_id = :OLD.manager_id;
    
    EXCEPTION 
    WHEN NO_DATA_FOUND THEN
        v_manager := 'BRAK';
    
    INSERT INTO archiwum_departamentow(id, nazwa, data_zamkniecia, ostatni_manager)
    VALUES(:OLD.department_id, :OLD.department_name, SYSDATE, v_manager);
END;
/

BEGIN
    DELETE FROM DEPARTMENTS WHERE DEPARTMENT_ID = 310;
END;
/

-- zadanie 2

CREATE TABLE zlodziej (
    id NUMBER PRIMARY KEY,
    "USER" VARCHAR2(50),
    czas_zmiany DATE
);

CREATE SEQUENCE zlodziej_seq START WITH 1;

CREATE OR REPLACE TRIGGER check_salary
BEFORE INSERT OR UPDATE ON employees
FOR EACH ROW
DECLARE
    v_user VARCHAR2(50);
    PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
    v_user := USER;

    IF :NEW.salary < 2000 OR :NEW.salary > 26000 THEN
        INSERT INTO zlodziej(id, "USER", czas_zmiany) VALUES(zlodziej_seq.NEXTVAL, v_user, SYSDATE);
        COMMIT;
        RAISE_APPLICATION_ERROR(-20001, 'Wynagrodzenie musi być w widełkach 2000 - 26000!');
    END IF;
END;
/

BEGIN
UPDATE EMPLOYEES SET SALARY = 250000 WHERE employee_id = 2025;
END;
/

-- zadanie 3

CREATE SEQUENCE employees_autoincrement_seq START WITH 2026 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trigger_employees_autoincrement
BEFORE INSERT ON employees
FOR EACH ROW
BEGIN
    :NEW.employee_id := employees_autoincrement_seq.NEXTVAL;
END;
/

BEGIN
INSERT INTO EMPLOYEES (FIRST_NAME, LAST_NAME, EMAIL, PHONE_NUMBER, HIRE_DATE, JOB_ID, SALARY, COMMISSION_PCT, MANAGER_ID, DEPARTMENT_ID)
VALUES ('Jan', 'Nowak', 'jn12345@poczta.pl', '111222333', TO_DATE('2025-07-01', 'YYYY-MM-DD'), 'IT_PROG', 2500, 0.25, NULL, 10);
END;
/

-- zadanie 4

CREATE OR REPLACE TRIGGER lock_job_grades
BEFORE INSERT OR UPDATE OR DELETE ON job_grades
BEGIN
    RAISE_APPLICATION_ERROR(-20002, 'Operacje na JOB_GRADES są zabronione!');
END;
/

BEGIN
INSERT INTO JOB_GRADES VALUES ('G', 201000, 500000);
UPDATE JOB_GRADES SET min_salary = 500000;
DELETE FROM JOB_GRADES;
END;
/

-- zadanie 5

CREATE OR REPLACE TRIGGER keep_salary_range
BEFORE UPDATE OF min_salary, max_salary ON jobs
FOR EACH ROW
BEGIN
    :NEW.min_salary := :OLD.min_salary;
    :NEW.max_salary := :OLD.max_salary;
    DBMS_OUTPUT.PUT_LINE('Zmiana min/max_salary jest niedozwolona – zostawiono stare wartości.');
END;
/

BEGIN
UPDATE jobs SET min_salary = 500000 WHERE job_id = 'IT_PROG';
UPDATE jobs SET max_salary = 500000 WHERE job_id = 'IT_PROG';
END;
/

-- zadanie 6

-- Utworzone wyzwalacze działają świetnie

