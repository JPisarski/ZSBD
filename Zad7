-- zadanie 1

CREATE OR REPLACE FUNCTION get_job_title(
    p_job_id IN jobs.job_id%TYPE
)
RETURN VARCHAR2
IS
    v_title jobs.job_title%TYPE;
    e_no_job EXCEPTION;
BEGIN
    SELECT job_title INTO v_title FROM jobs WHERE job_id = p_job_id;
    RETURN v_title;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 'Taka praca nie istnieje!';
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE('Nazwa pracy: ' || get_job_title('IT_PROG'));
END;
/

-- zadanie 2

CREATE OR REPLACE FUNCTION yearly_salary(
    p_emp_id IN employees.employee_id%TYPE
)
RETURN NUMBER
IS
    v_sal employees.salary%TYPE;
    v_comm employees.commission_pct%TYPE;
BEGIN
    SELECT salary, NVL(commission_pct, 0)
    INTO v_sal, v_comm
    FROM employees WHERE employee_id = p_emp_id;

    RETURN v_sal * 12 + (v_sal * v_comm);

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN NULL;
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE('Roczne wynagrodzenie: ' || yearly_salary(2025));
END;
/

-- zadanie 3

CREATE OR REPLACE FUNCTION get_area_code(
    p_phone IN VARCHAR2
)
RETURN VARCHAR2
IS
BEGIN

    RETURN '(' || SUBSTR(p_phone, 1, INSTR(p_phone, '.') - 1) || ')' || SUBSTR(REPLACE(p_phone, '.', ''), INSTR(p_phone, '.'));
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE('Numer kierunkowy: ' || get_area_code('555.555.5555'));
END;
/

-- zadanie 4

CREATE OR REPLACE FUNCTION capitalize_edges(
    p_text IN VARCHAR2
)
RETURN VARCHAR2
IS
BEGIN
    IF p_text IS NULL OR LENGTH(p_text) < 2 THEN
        RETURN p_text;
    END IF;

    RETURN UPPER(SUBSTR(p_text, 1, 1))
           || LOWER(SUBSTR(p_text, 2, LENGTH(p_text) - 2))
           || UPPER(SUBSTR(p_text, -1, 1));
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE('Tekst: ' || capitalize_edges('ALFA I OMEGA'));
END;
/

-- zadanie 5

CREATE OR REPLACE FUNCTION pesel_to_date(
    p_pesel IN VARCHAR2
)
RETURN DATE
IS
    v_year  NUMBER;
    v_month NUMBER;
    v_day   NUMBER;
BEGIN
    v_year  := SUBSTR(p_pesel, 1, 2);
    v_month := SUBSTR(p_pesel, 3, 2);
    v_day   := SUBSTR(p_pesel, 5, 2);

    IF v_month BETWEEN 1 AND 12 THEN
        v_year := 1900 + v_year;
    ELSIF v_month BETWEEN 21 AND 32 THEN
        v_year := 2000 + v_year;
        v_month := v_month - 20;
    END IF;
    
    RETURN TO_DATE(v_year || '-' || v_month || '-' || v_day, 'YYYY-MM-DD');

EXCEPTION
    WHEN OTHERS THEN
        RETURN NULL;
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE('Data urodzenia: ' || pesel_to_date('99062407777'));
END;
/

-- zadanie 6

CREATE OR REPLACE FUNCTION stats_by_country(
    p_country_name IN countries.country_name%TYPE
)
RETURN VARCHAR2
IS
    v_country_id countries.country_id%TYPE;
    v_emp_count NUMBER;
    v_dept_count NUMBER;
BEGIN

    SELECT country_id INTO v_country_id FROM countries WHERE country_name = p_country_name;

    SELECT COUNT(*)
    INTO v_dept_count
    FROM departments d
    JOIN locations l ON d.location_id = l.location_id
    WHERE l.country_id = v_country_id;

    SELECT COUNT(*)
    INTO v_emp_count
    FROM employees e
    JOIN departments d ON e.department_id = d.department_id
    JOIN locations l ON d.location_id = l.location_id
    WHERE l.country_id = v_country_id;

    RETURN 'Pracownicy: ' || v_emp_count || ', Departamenty: ' || v_dept_count;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 'Brak takiego kraju!';
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE('United States of America: ' || stats_by_country('United States of America'));
    DBMS_OUTPUT.PUT_LINE('Ukraine: ' || stats_by_country('Ukraine'));
END;
/

-- zadanie 7

CREATE OR REPLACE FUNCTION gen_access_id(
    p_last_name IN VARCHAR2,
    p_phone     IN VARCHAR2,
    p_first_name IN VARCHAR2
)
RETURN VARCHAR2
IS
    v_last4 VARCHAR2(4);
BEGIN
    v_last4 := SUBSTR(REPLACE(p_phone, '.', ''), -4);

    RETURN UPPER(SUBSTR(p_last_name, 1, 3))
           || v_last4
           || UPPER(SUBSTR(p_first_name, 1, 1));
END;
/

BEGIN
    DBMS_OUTPUT.PUT_LINE(gen_access_id('Nowak', '555.555.5555', 'Jan'));
END;
/

