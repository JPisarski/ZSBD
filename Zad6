-- zadanie 1

CREATE OR REPLACE PROCEDURE add_job(
    p_job_id    IN jobs.job_id%TYPE,
    p_job_title IN jobs.job_title%TYPE
)
IS
BEGIN
    INSERT INTO jobs(job_id, job_title)
    VALUES(p_job_id, p_job_title);

    DBMS_OUTPUT.PUT_LINE('Dodano job: ' || p_job_id);

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd dodawania JOB: ' || SQLERRM);
END;
/

-- zadanie 2

CREATE OR REPLACE PROCEDURE update_job_title(
    p_job_id       IN jobs.job_id%TYPE,
    p_new_title    IN jobs.job_title%TYPE
)
IS
    e_no_jobs_updated EXCEPTION;
BEGIN
    UPDATE jobs
    SET job_title = p_new_title
    WHERE job_id = p_job_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE e_no_jobs_updated;
    END IF;

    DBMS_OUTPUT.PUT_LINE('Zaktualizowano job: ' || p_job_id);

EXCEPTION
    WHEN e_no_jobs_updated THEN
        DBMS_OUTPUT.PUT_LINE('Brak jobów do aktualizacji!');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;
/

-- zadanie 3

CREATE OR REPLACE PROCEDURE delete_job(
    p_job_id IN jobs.job_id%TYPE
)
IS
    e_no_jobs_deleted EXCEPTION;
BEGIN
    DELETE FROM jobs WHERE job_id = p_job_id;

    IF SQL%ROWCOUNT = 0 THEN
        RAISE e_no_jobs_deleted;
    END IF;

    DBMS_OUTPUT.PUT_LINE('Usunięto job: ' || p_job_id);

EXCEPTION
    WHEN e_no_jobs_deleted THEN
        DBMS_OUTPUT.PUT_LINE('Job o takim ID nie istnieje – nic nie usunięto.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd usuwania jobu: ' || SQLERRM);
END;
/

-- zadanie 4

CREATE OR REPLACE PROCEDURE get_emp_data(
    p_emp_id      IN employees.employee_id%TYPE,
    p_salary      OUT employees.salary%TYPE,
    p_last_name   OUT employees.last_name%TYPE
)
IS
BEGIN
    SELECT salary, last_name
    INTO p_salary, p_last_name
    FROM employees
    WHERE employee_id = p_emp_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Nie znaleziono pracownika');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;
/

-- zadanie 5

CREATE SEQUENCE emp_seq START WITH 207;

CREATE OR REPLACE PROCEDURE add_employee(
    p_first_name IN employees.first_name%TYPE DEFAULT NULL,
    p_last_name  IN employees.last_name%TYPE,
    p_salary     IN employees.salary%TYPE DEFAULT 10000,
    p_job_id     IN employees.job_id%TYPE DEFAULT 'IT_PROG',
    p_manager_id IN employees.manager_id%TYPE DEFAULT NULL,
    p_dept_id    IN employees.department_id%TYPE DEFAULT 60
)
IS
    e_salary_too_high EXCEPTION;
BEGIN
    IF p_salary > 20000 THEN
        RAISE e_salary_too_high;
    END IF;

    INSERT INTO employees(employee_id, first_name, last_name, job_id,
                          salary, manager_id, department_id)
    VALUES (emp_seq.NEXTVAL, p_first_name, p_last_name, p_job_id,
            p_salary, p_manager_id, p_dept_id);

    DBMS_OUTPUT.PUT_LINE('Dodano pracownika: ' || p_last_name);

EXCEPTION
    WHEN e_salary_too_high THEN
        DBMS_OUTPUT.PUT_LINE('Wynagrodzenie przekracza 20000!');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;
/

-- zadanie 6

CREATE OR REPLACE PROCEDURE avg_salary_by_manager(
    p_manager_id IN employees.manager_id%TYPE,
    p_avg_salary OUT NUMBER
)
IS
BEGIN
    SELECT AVG(salary)
    INTO p_avg_salary
    FROM employees
    WHERE manager_id = p_manager_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_avg_salary := NULL;
        DBMS_OUTPUT.PUT_LINE('Brak podwładnych.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;
/

-- zadanie 7

CREATE OR REPLACE PROCEDURE raise_department_salary(
    p_dept_id   IN departments.department_id%TYPE,
    p_percent   IN NUMBER
)
IS
    e_fk_error EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_fk_error, -2291);
BEGIN
    UPDATE employees e
    SET salary = salary * (1 + p_percent / 100)
    WHERE department_id = p_dept_id
    AND EXISTS (
        SELECT 1
        FROM jobs j
        WHERE j.job_id = e.job_id
        AND salary * (1 + p_percent / 100)
            BETWEEN j.min_salary AND j.max_salary
    );

    DBMS_OUTPUT.PUT_LINE('Zaktualizowano ' || SQL%ROWCOUNT || ' pracowników.');

EXCEPTION
    WHEN e_fk_error THEN
        DBMS_OUTPUT.PUT_LINE('Nie istnieje taki department_id!');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd podwyżki: ' || SQLERRM);
END;
/

-- zadanie 8

CREATE OR REPLACE PROCEDURE move_employee(
    p_emp_id      IN employees.employee_id%TYPE,
    p_new_dept_id IN departments.department_id%TYPE
)
IS
    v_temp NUMBER;

    e_no_employee EXCEPTION;
    e_no_department EXCEPTION;
BEGIN
    -- sprawdzenie pracownika
    SELECT COUNT(*) INTO v_temp FROM employees WHERE employee_id = p_emp_id;
    IF v_temp = 0 THEN
        RAISE e_no_employee;
    END IF;

    -- sprawdzenie departamentu
    SELECT COUNT(*) INTO v_temp FROM departments WHERE department_id = p_new_dept_id;
    IF v_temp = 0 THEN
        RAISE e_no_department;
    END IF;

    UPDATE employees
    SET department_id = p_new_dept_id
    WHERE employee_id = p_emp_id;

    DBMS_OUTPUT.PUT_LINE('Przeniesiono pracownika ' || p_emp_id);

EXCEPTION
    WHEN e_no_employee THEN
        DBMS_OUTPUT.PUT_LINE('Pracownik nie istnieje!');
    WHEN e_no_department THEN
        DBMS_OUTPUT.PUT_LINE('Nowy departament nie istnieje!');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd podczas przenoszenia: ' || SQLERRM);
END;
/

-- zadanie 9

CREATE OR REPLACE PROCEDURE delete_department(
    p_dept_id IN departments.department_id%TYPE
)
IS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM employees
    WHERE department_id = p_dept_id;

    IF v_count > 0 THEN
        DBMS_OUTPUT.PUT_LINE('Nie można usunąć – są pracownicy w departamencie.');
        RETURN;
    END IF;

    DELETE FROM departments WHERE department_id = p_dept_id;

    DBMS_OUTPUT.PUT_LINE('Usunięto departament: ' || p_dept_id);

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Błąd usuwania departamentu: ' || SQLERRM);
END;
/
